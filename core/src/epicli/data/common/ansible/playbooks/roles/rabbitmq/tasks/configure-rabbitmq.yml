---
- name: RabbitMQ | Copy default config file
  template:
    src: rabbitmq-server.j2
    dest: /etc/rabbitmq/rabbitmq.conf
    owner: root
    group: root
    mode: "u=rw,go=r"
  register: config_file_stat

- name: RabbitMQ | Copy default default env config file
  template:
    src: rabbitmq-env.conf.j2
    dest: /etc/rabbitmq/rabbitmq-env.conf
    owner: root
    group: root
    mode: "u=rw,go=r"
  register: env_file_stat

- name: RabbitMQ | Symlink bin to sbin (for plugins installation)
  file:
    src: /usr/lib/rabbitmq/bin
    dest: /usr/lib/rabbitmq/sbin
    state: link

- name: RabbitMQ | Enable plugins that were installed
  rabbitmq_plugin:
    names: "{{ item }}"
    prefix: /usr/lib/rabbitmq
    state: enabled
    new_only: no
  loop: "{{ specification.rabbitmq_plugins }}"

- name: RabbitMQ | Restart service
  when:
    - config_file_stat.changed or env_file_stat.changed
    - not stop_rabbitmq_service
  service:
    name: rabbitmq-server
    enabled: true
    state: restarted

- name: RabbitMQ | Stop service for manual certificates configuration
  when: stop_rabbitmq_service
  service:
    name: rabbitmq-server
    state: stopped
