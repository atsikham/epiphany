---
- name: Verify
  hosts: postgresql
  gather_facts: false
  tasks:
    - name: Check that DB port is open
      block:
        - name: Ensure that DB port is open
          wait_for:
            host: 0.0.0.0
            port: 5432
            state: started
            delay: 0
            timeout: 3
          register: port_status

        - name: Verify that port status is not changed
          assert:
            that:
              - not port_status.changed

    - name: Check that PostgreSQL services are started and enabled
      block:
        - name: Ensure that postgresql service is started and enabled
          systemd:
            name: postgresql
            enabled: true
          register: svc_status

        - name: Ensure that postgresql@13-main service is started and enabled
          systemd:
            name: postgresql@13-main
            enabled: true
          register: svc_main_status

        - name: Verify that service statuses are not changed
          assert:
            that:
              - not svc_status.changed
              - not svc_main_status.changed

    - name: Check that repmgrd service is started and enabled
      block:
        - name: Ensure that repmgrd service is started and enabled
          systemd:
            name: repmgrd
            enabled: true
          register: svc_repmgr_status

        - name: Verify that service status is not changed
          assert:
            that:
              - not svc_repmgr_status.changed
